<!DOCTYPE html>
<!--[if lt IE 9]><html class="no-js lt-ie9" lang="en" dir="ltr"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en" dir="ltr"><!--<![endif]-->
	<head>
<!-- Based on CDTS 4.1.0 (https://cenw-wscoe.github.io/sgdc-cdts/docs/index-en.html) with DECoE customizations added (look for "DECoE customization" in comments) -->
	 <meta charset="utf-8">

<!-- Start DECoE customization -->
		<title>
			Licence area - NCLL portal - Spectrum licensing services - Innovation, Science and Economic Development Canada
		</title>
<!-- End DECoE customization -->

		<meta content="width=device-width,initial-scale=1" name="viewport">
		<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
		<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
		<noscript>
			<!-- Write closure fall-back static file -->
			<!-- refTop.html -->
		</noscript>
		<!-- Write closure template -->
		<script>
			document.write(wet.builder.refTop({
				"cdnEnv": "esdcprod"
			}));
		</script>

<!-- Start DECoE customization -->

<link rel="stylesheet" href="libs/leaflet.css"/>
<link rel="stylesheet" href="src/leaflet.draw.css"/>


<!-- src does not work with folder, this is long but the best I can do because of 
	how leaflet draw is designed. -->
<script src="libs/leaflet-src.js"></script>
<script src="src/Leaflet.draw.js"></script>
<script src="src/Leaflet.Draw.Event.js"></script>
<script src="src/edit/handler/Edit.Poly.js"></script>
<script src="src/edit/handler/Edit.SimpleShape.js"></script>
<script src="src/edit/handler/Edit.Rectangle.js"></script>
<script src="src/draw/handler/Draw.Feature.js"></script>
<script src="src/draw/handler/Draw.Polyline.js"></script>
<script src="src/draw/handler/Draw.Polygon.js"></script>
<script src="src/draw/handler/Draw.SimpleShape.js"></script>
<script src="src/draw/handler/Draw.Rectangle.js"></script>
<script src="src/draw/handler/Draw.Circle.js"></script>
<script src="src/draw/handler/Draw.Marker.js"></script>
<script src="src/draw/handler/Draw.CircleMarker.js"></script>
<script src="src/ext/TouchEvents.js"></script>
<script src="src/ext/LatLngUtil.js"></script>
<script src="src/ext/GeometryUtil.js"></script>
<script src="src/ext/LineUtil.Intersect.js"></script>
<script src="src/ext/Polyline.Intersect.js"></script>
<script src="src/ext/Polygon.Intersect.js"></script>
<script src="src/Control.Draw.js"></script>
<script src="src/Tooltip.js"></script>
<script src="src/Toolbar.js"></script>
<script src="src/draw/DrawToolbar.js"></script>
<script src="src/edit/EditToolbar.js"></script>
<script src="src/edit/handler/EditToolbar.Edit.js"></script>
<script src="src/edit/handler/EditToolbar.Delete.js"></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

<script src="https://unpkg.com/esri-leaflet"></script>

<!-- Esri Leaflet Geocoder -->
<link
  rel="stylesheet"
  href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css"
/>
<script src="https://unpkg.com/esri-leaflet-geocoder"></script>


	<style>
		/* Styles for all mockups */
			.notesaboutmockup {
				color: #333;
				background: #FFD;
				padding: 0 1em;
				border-color: #FC6;
				border-width: 2px;
				border-style: solid;
				margin-top: 3em;
			}
			.notesaboutmockup h2 {
				font-size: inherit;
				margin-top: 1em;
			}
		/* Styles for this mockup */
			#superhead {
				font-size: 1.7em;
				font-weight: bold;
			}
			#status {
				border-left: 3px solid #999;
				padding-left: 2px;
				background-color: #EEE;
			}
			ul.nav-wizard li {
				font-size: inherit;
			}
			#map {
				border: 1px solid black;
				height: 70em;
				margin-top: 38px; /* to match the default for the <h2> beside it */
				margin-bottom: 2em;
			}
			#WKT {
				width: 100%;
			}
			@media (min-width: 768px) {
				.dl-horizontal dt {
					width: 15em;
				}
			}
			#area-information-after > p {
				margin-top: 1em;
			}
			.highlight {
				background-color: yellow;
			}
	</style>
	<link href="fix-wet-styles.css" rel="stylesheet" type="text/css">
	<link href="https://sms-sgs.ic.gc.ca/static/css/wizard.css" rel="stylesheet" type="text/css">
	<link href="ncll-portal.css" rel="stylesheet" type="text/css">
<!-- End DECoE customization -->

	</head>
	<body vocab="http://schema.org/" typeof="WebPage">
		<div id="def-top">
			<!-- Write closure fall-back static file -->
			<!-- transactTop-en.html -->
		</div>
		<!-- Write closure template -->
		<script>
			var defTop = document.getElementById("def-top");
			defTop.outerHTML = wet.builder.top({
				"cdnEnv": "esdcprod",
				"lngLinks": [{
					"lang": "fr",
					"href": "transactional-fr.shtml",
					"text": "Fran√ßais"
				}],
				"search": false,
				"siteMenu": false,
				"breadcrumbs": [{
					"title": "SMS",
					"href": "index.html"
				},
				{
					"title": "NCLL portal",
					"href": "dashboard.html"
				}],
				"showPreContent": false
			});
		</script>
		<main property="mainContentOfPage" typeof="WebPageElement" class="container">

<!-- Start page content -->

	<div id="superhead">
		<p>Non-competitive local licence application (01000139-001) <span class="pull-right" id="status">Draft</span></p>
	</div>
	<div class="form-group">
		<ul class="nav nav-wizard">
			<li><a href="contact.html">Contact information</a></li>
			<li><a href="general.html">General information</a></li>
			<li class="active" aria-current="step">Licence area</li>
			<li>Technical details</li>
			<li>Review</li>
		</ul>
	</div>

	<div class="wb-frmvld">
		<form action="tech-details.html" method="get">
			<div class="wb-frm">
				<div class="container">
					<h1 property="name" id="wb-cont">Licence area</h1>
					<p>Your licence area must be defined by between 3 and 12 boundary points, connected with straight lines. It may be convex or concave but it may not intersect itself.</p>
					<p>These boundary points may be entered in any of the following ways:</p>
					<ol>
						<li>Entering them into the Boundary points table below</li>
						<li>Drawing the boundary on the interactive map</li>
						<li>Entering a description of the boundary in <abbr>WKT</abbr> (Well Known Text) format into the input field below the map</li>
					</ol>
					<p>Remember that you will need to be able to cover the full licence area. And because low power licences have a better chance of being approved, you may want to limit the size of your licence area to 15 km<sup>2</sup> or less, or apply for multiple such licences.</p>
					<p><b>Note</b>: this application form is not designed to assist with network planning. If you would like to identify the boundary of an area that will not cause interference with other operators, please consider using our <a href="SLAB-en-leaflet.html" target="_blank">Spectrum licence area browser</a>.</p>

					<div class="row wb-eqht">
					<div class="col-md-4">
						<h2>Boundary points</h2>
						<p>Latitude and longitude are in degree decimal format.</p>
						<table class="table form-group">
							<tr>
								<th><span class="wb-inv">Number</span></th>
								<th>Latitude</th>
								<th>Longitude</th>
							</tr>
							<tr><td>1</td><td><input id="lat1" name="lat1" class="form-control" size=9 inputmode="decimal"></td><td><input id="long1" name="long1" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>2</td><td><input id="lat2" name="lat2" class="form-control" size=9 inputmode="decimal"></td><td><input id="long2" name="long2" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>3</td><td><input id="lat3" name="lat3" class="form-control" size=9 inputmode="decimal"></td><td><input id="long3" name="long3" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>4</td><td><input id="lat4" name="lat4" class="form-control" size=9 inputmode="decimal"></td><td><input id="long4" name="long4" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>5</td><td><input id="lat5" name="lat5" class="form-control" size=9 inputmode="decimal"></td><td><input id="long5" name="long5" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>6</td><td><input id="lat6" name="lat6" class="form-control" size=9 inputmode="decimal"></td><td><input id="long6" name="long6" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>7</td><td><input id="lat7" name="lat7" class="form-control" size=9 inputmode="decimal"></td><td><input id="long7" name="long7" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>8</td><td><input id="lat8" name="lat8" class="form-control" size=9 inputmode="decimal"></td><td><input id="long8" name="long8" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>9</td><td><input id="lat9" name="lat9" class="form-control" size=9 inputmode="decimal"></td><td><input id="long9" name="long9" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>10</td><td><input id="lat10" name="lat10" class="form-control" size=9 inputmode="decimal"></td><td><input id="long10" name="long10" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>11</td><td><input id="lat11" name="lat11" class="form-control" size=9 inputmode="decimal"></td><td><input id="long11" name="long11" class="form-control" size=9 inputmode="decimal"></td></tr>
							<tr><td>12</td><td><input id="lat12" name="lat12" class="form-control" size=9 inputmode="decimal"></td><td><input id="long12" name="long12" class="form-control" size=9 inputmode="decimal"></td></tr>
						</table>
					</div>
					<div class="col-md-8">
						<details>
							<summary>Instructions on how to navigate and draw with map</summary>
							<p>To navigate the map:</p>

							<ul>
								<li>Search using the search bar at the top left of the map</li>
								<li>Click and drag to move the map</li>
								<li>Zoom in:</li>
								<ul>
									<li>Double click</li>
									<li>Scroll</li>
									<li>Click the zoom icons on the bottom right</li>
								</ul>
							</ul>
							<p>To draw:</p>
								<ol>
									<li>Navigate to your location</li>
									<li>Click the draw tool
										<svg width="30" height="30">
											<path xmlns="http://www.w3.org/2000/svg" transform="translate(-73,-15)" id="polygon" d="M 100,24.565 97.904,39.395 83.07,42 76,28.773 86.463,18 Z" style="fill:#464646;fill-opacity:1"/>
										  </svg>

									</li>
									<li>Click on the map to add points. These are connected by straight lines.</li>
									<li>Close your boundary:</li>
									<ul>
										<li>Click the first points</li>
										<li>Click the finish button next to the draw icon</li>
									</ul>
									<li>Edit your boundary:</li>
									<ul>
										<li>Drag the white points to move them</li>
										<li>Drag the translucent points to add new points</li>
									</ul>
								</ol>
						</details>
						<div id="map"></div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-12">
						<div class="form-group">
							<label for="WKT">
								<span class="field-name">
									Boundary description in WKT (Well Known Text) format
								</span>
							</label>
							<details>
								<summary>More information</summary>
								<p>WKT is a compact format for describing mathematical shapes, including polygons. Each vertex is a longitude-latitude pair.</p>
								<p>e.g. POLYGON((<span class="highlight">-113.956370 50.880852</span>,<span class="highlight">-113.952550 50.880744</span>,<span class="highlight">-113.944869 50.882288</span>,<span class="highlight">-113.945942 50.884372</span>,<span class="highlight">-113.951950 50.883398</span>,<span class="highlight">-113.956885 50.882369</span>,<span class="highlight">-113.956370 50.880852</span>))</p>
								<p>The input field below accepts up to 12 pairs.</p>
							</details>
							<textarea id="WKT" name="WKT" class="form-control" rows="3" placeholder="Enter WKT text here"></textarea>
						</div>

						<p>Once your area is entered, click <kbd><samp>Calculate</samp></kbd> to get the information about the area and to calculate the licence fee</p>
						<button type="button" class="btn btn-call-to-action" id="calculate-button">Calculate</button>

						<h2>Area information</h2>
						<div id="area-information-before">
							<p>Press <kbd><samp>Calculate</samp></kbd> to see results.</p>
						</div>
						<div id="area-information-after" hidden>
							<p><strong>Area size</strong> - <span class="area-size" id="area-size">162</span> km<sup>2</sup></p>
							<details>
								<summary>More information on area size</summary>
								<p>Total area covered by the licence</p>
							</details>

							<p><strong>Fee zone</strong> - <span class="fee-zone-type">Rural</span>: $<span class="base-rate">0.45</span> per MHz per year per km<sup>2</sup></p>
							<details>
								<summary>More information on fee zone</summary>
								<p>Licences in:</p>
								<ul class="list-unstyled">
									<li>Remote areas cost $0.01 per MHz per year per km<sup>2</sup></li>
									<li>Urban areas cost $1.80 per MHz per year per km<sup>2</sup></li>
									<li>Rural areas cost $0.45 per MHz per year per km<sup>2</sup></li>
								</ul>
							</details>

							<p><strong>Licence type</strong> - <span class="licence-type">Medium power (##</span> dBm/MHz)</p>
							<details>
								<summary>More information on licence type</summary>
								<ul class="list-unstyled">
									<li>Urban areas are low power (## dBm/MHz)</li>
									<li>Areas between 0&ndash;15 km<sup>2</sup> are low-power (## dBm/MHz)</li>
									<li>Areas between 75&ndash;165 km<sup>2</sup> are medium-power (## dBm/MHz)</li>
								</ul>
								<p>You can apply for multiple licences to cover an area larger than 15 km<sup>2</sup> with low power</p>
							</details>

							<p><strong>Scope of coverage</strong> - <span class="antenna">Indoor/outdoor</span></p>
							<details>
								<summary>More information on scope of coverage</summary>
								<ul class="list-unstyled">
									<li>Low power licences can be indoor/outdoor or indoor only</li>
									<li>Medium power licences can only be indoor/outdoor</li>
								</ul>
								<p>You can apply for multiple licences in order to cover an area larger than 15 km<sup>2</sup> that is indoor</p>
							</details>
						</div>

						<h2>Licence fee</h2>
						<div id="licence-fee-before">
							<p>Press <kbd><samp>Calculate</samp></kbd> to see results.</p>
						</div>
						<div id="licence-fee-after" hidden>
							<dl class="dl-horizontal">
								<dt>Base rate (Rural) per year</dt>
								<dd>$<span class="base-rate">0.45</span> per MHz per km<sup>2</sup></dd>
								<dt>Requested bandwidth</dt>
								<dd><span class="bandwidth">10</span> MHz</dd>
								<dt>Area size</dt>
								<dd><span class="area-size">162</span> km<sup>2</sup></dd>
								<dt>Total cost per year</dt>
								<dd>$<span class="base-rate">0.45</span> &times; <span class="bandwidth">10</span> &times; <span class="area-size">162</span> = $<span class="total-cost">729.00</span></dd>
							</dl>
						</div>
					</div>
				</div>

				<section id="save-div" class="alert alert-success" hidden>
					<p>Application saved as draft</p>
				</section>
				<button class="btn btn-primary" type="submit" id="next-button" hidden>Next</button>
				<button class="btn btn-secondary" type="button" id="save-button">Save</button>
				<br>
				<button class="btn btn-secondary" type="button" onclick="history.back()">Back</button>

				<div class="notesaboutmockup">
					<h2>Notes about this mockup:</h2>
					<ul>
						<li>TODO: remove back button?</li>
					</ul>
				</div>
			</div>
		</div>
	</form>
	<script>
		const calculateButton = document.getElementById ( "calculate-button" )
		const areaInformationBefore = document.getElementById ( "area-information-before" )
		const areaInformationAfter = document.getElementById ( "area-information-after" )
		const licenceFeeBefore = document.getElementById ( "licence-fee-before" )
		const licenceFeeAfter = document.getElementById ( "licence-fee-after" )
		const nextButton = document.getElementById ( "next-button" )
		calculateButton.addEventListener ( "click", (event) => {
			areaInformationBefore .setAttribute ( "hidden", "hidden" )
			areaInformationAfter .removeAttribute ( "hidden" )
			licenceFeeBefore .setAttribute ( "hidden", "hidden" )
			licenceFeeAfter .removeAttribute ( "hidden" )
			nextButton .removeAttribute ( "hidden" )
		})
	</script>
	<script>
		const saveButton = document.getElementById ( "save-button" )
		const saveDiv = document.getElementById ( "save-div" )
		saveButton.addEventListener ( "click", (event) => {
			saveDiv .removeAttribute ( "hidden" )
		})
	</script>
	<script src="catch-and-throw.js"></script>
	<script>
		// Calculate the licence fee
		// Get base rate
		const baseRate = .45 // hardcode for now (this is the rural rate)
		for ( let elem of document .getElementsByClassName ( "base-rate" ) ) {
			elem .innerText = baseRate
		}
		createHiddenField ( "base-rate", baseRate )

		// Get bandwidth (from previous page)
		const bandwidth = urlParams.get ( "bandwidth" )
		for ( let elem of document .getElementsByClassName ( "bandwidth" ) ) {
			elem .innerText = bandwidth
		}
		createHiddenField ( "bandwidth", bandwidth )
		
		// Get area size
		const areaSize = 162 // hardcode for now, but this should come from Leaflet.js
		for ( let elem of document .getElementsByClassName ( "area-size" ) ) {
			elem .innerText = areaSize
		}
		var area_field = createHiddenField ( "area-size", areaSize )

		// Calculate total cost
		const totalCost = ( baseRate * bandwidth * areaSize ) .toFixed ( 2 )
		for ( let elem of document .getElementsByClassName ( "total-cost" ) ) {
			elem .innerText = totalCost
		}
		var cost_field = createHiddenField ( "total-cost", totalCost )

	</script>
	</div>
	<div id="change-licensee">
		<div class="container">
			<div class="row">
				<div class="col-xs-offset-8 col-xs-4">
					<details>
						<summary>The Best Company</summary>
						<p><a href="select-licensee.html">Switch licensee account</a></p>
						<p class="border-top"><a href="login.html"><span class="glyphicon-log-out glyphicon"></span> Sign out</a></p>
					</details>
				</div>
			</div>
		</div>
	</div>
	<script>
		// Move #change-licensee to top of screen
		// We want it to be immediately under the dark horizontal line, but that line is added by WET so we can't access it until after WET does its thing
		// This does lead to z-index issues: the "Log out" button can't currently be reached because it's behind the <main> element
		const changeLicensee = document .getElementById ( "change-licensee" )
		const wbBc = document .getElementById ( "wb-bc" )
		wbBc .prepend ( changeLicensee )
	</script>
<!-- End page content -->

			<div id="def-preFooter">
				<!-- Write closure fall-back static file -->
				<!-- preFooter-en.html -->
			</div>
			<!-- Write closure template -->
			<script>
				var defPreFooter = document.getElementById("def-preFooter");
				defPreFooter.outerHTML = wet.builder.preFooter({
					"cdnEnv": "esdcprod",
					"versionIdentifier": "CD56",
					"showPostContent": false,
					"showFeedback": false,
					"showShare": false
				});
			</script>
		</main>
		<div id="def-footer">
			<!-- Write closure fall-back static file -->
			<!-- transactFooter-en.html -->
		</div>
		<!-- Write closure template -->
		<script>
			var defFooter = document.getElementById("def-footer");
			defFooter.outerHTML = wet.builder.footer({
				"cdnEnv": "esdcprod",
				"showFooter": false,
				"showFeatures": false,
				"termsLink": [{
        			"newWindow": true
				}],
				"privacyLink": [{
					"newWindow": true
				}],
				"contextualFooter":{
					"title": "Spectrum and Telecommunications Sector",
					"links": [{
						"text": "Contact us",
						"href":"https://ised-isde.canada.ca/site/spectrum-management-telecommunications/en/licences-and-certificates/radiocom-information-circulars-ric/ric-66-addresses-and-telephone-numbers-district-offices",
						"newWindow": true
					}]
				}
			});
		</script>
		<!-- Write closure template -->
		<script>
			document.write(wet.builder.refFooter({
				"cdnEnv": "esdcprod"
			}));
		</script>
		<script>


		// Leaftlet code

			function reset_lat_lngs() {
				for (let i = 0; i < 12; i++) {
					document.getElementById("lat" + (i+1)).value = "";
					document.getElementById("long" + (i+1)).value = "";
				}

				document.getElementById("WKT").value = "";

				area_size_spans = document.querySelectorAll(".area-size");

				area_size_spans.forEach(element => {
					element.innerText = element.textContent = "0";
				});

				total_cost_spans = document.querySelectorAll(".total-cost");
				total_cost_spans.forEach(element => {
					element.innerText = element.textContent = "0";
				});

				area_field.setAttribute( "value", "0" );
				cost_field.setAttribute( "value", "0" );
					
			}

	

			function change_lat_lngs(latlngs) {
				area = L.GeometryUtil.geodesicArea(latlngs);
				lat_long_sliced = latlngs.slice(0,12)
				wkt = "POLYGON(("
				for (let i = 0; i < 12; i++) {
					lat_id = "lat" + (i+1)
					long_id = "long" + (i+1)
					if (i < lat_long_sliced.length) {
						document.getElementById(lat_id).value = latlngs[i].lat.toFixed(6);
						document.getElementById(long_id).value = latlngs[i].lng.toFixed(6);
						wkt += latlngs[i].lat.toFixed(6) + " " + latlngs[i].lng.toFixed(6) + ","
					} else {
						document.getElementById(lat_id).value = "";
						document.getElementById(long_id).value = "";
					}
					
				}
			
				wkt = wkt.substring(0,wkt.length-1)
				wkt += "))"

				document.getElementById("WKT").value = wkt;

				area_size_spans = document.querySelectorAll(".area-size");

				let area_number = (parseFloat(L.GeometryUtil.readableArea(area, true, 5).slice(0, -3))/100).toFixed(3);

				area_size_spans.forEach(element => {
					element.innerText = element.textContent = area_number
				});

				area_field.setAttribute( "value", area_number );

				let cost_number = (bandwidth * 0.45 * (area_number)).toFixed(2);

				total_cost_spans = document.querySelectorAll(".total-cost");
				total_cost_spans.forEach(element => {
					element.innerText = element.textContent = cost_number
				});

				cost_field.setAttribute("value", cost_number);
			}

			// create map and center to Muskeg
            var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    osm = L.tileLayer(osmUrl, {maxZoom: 18, attribution: osmAttrib}),
                    map = new L.Map('map', {zoomControl:false, layers: [osm], center: new L.LatLng(63.27268094792591, -100.5815661012755), zoom: 3.3,selectedPathOptions: {
                color:'#ff9900'
                }});
        
			// add the polygon that will be drawn to the map
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
        
			// add zoom to the bottom right
            new L.Control.Zoom({ position: 'bottomright' }).addTo(map);

			// add Fullscreen to the top right. Currently broken
            new L.Control.Fullscreen({pseudoFullscreen: true, position: 'topright'}).addTo(map);



			// Layers.

			// Map layers. Not implemented.
			const baseLayers = {
				'Standard': osm,
				'Terrain': osm
			};

			// Fee zone layer.
			const feezone = L.layerGroup();
			const overlays = {
				'Fee Zones': feezone,
			};

			// Add layer buttom to the top right.
			const layerControl = L.control.layers(baseLayers, overlays, {position: 'topleft'});

			// Draw control, removes everything but polygon,
			// and removes intersection from polygon.
			// Add area and restrict to 12 points.
        
            var drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polyline: false,
                    polygon: true,
                    circle: false,
                    rectangle: false,
                    marker: false,
                    circlemarker: false,
                polygon: {
                        allowIntersection: false,
                        showArea: true,
                        maxPoints:12,
                metric: "km",
                precision: {km:5},
                shapeOptions: {
                        fillColor :'#bf00ff',
                    fillOpacity:0.65,
                    color:"#8600b3",
                    opacity: 1
                          }
                }
        
                },
            });

			// Add search, currently does not work well, as I have not added an API key.
			var searchControl = L.esri.Geocoding.geosearch({
				expanded: true,
        	})

			map.addControl(searchControl)
            map.addControl(drawControl);
			map.addControl(layerControl);

			// add scale to the bottom left.
            var scale = L.control.scale(); 
                 scale.addTo(map); 
        
        
			// When the user clicks the trashcan, remove everything and change the icon back to the polygon.
            L.Control.RemoveAll = L.Control.extend({
                options: {
                    position: 'topleft',
                },
        
                onAdd: function (map) {
                    var controlDiv = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
                    var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                    controlUI.title = 'Remove all drawn items';
                    controlUI.setAttribute('href', '#');

                    controlUI.style.backgroundImage = 'url(src/images/trash.svg)'
        
                    L.DomEvent
                        .addListener(controlUI, 'click', L.DomEvent.stopPropagation)
                        .addListener(controlUI, 'click', L.DomEvent.preventDefault)
                        .addListener(controlUI, 'click', function () {
							reset_lat_lngs();
                            drawnItems.clearLayers();
                            map.removeControl(removeAllControl);
							map.removeControl(layerControl);
            				map.addControl(drawControl);
							map.addControl(layerControl);
                        });
                    return controlDiv;
                }
            });
        
        removeAllControl = new L.Control.RemoveAll();
        
        
        // Add area on hover
        
        var getPopupContent = function(layer) {
        
                  var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                  area = L.GeometryUtil.geodesicArea(latlngs);
                  return "Area: "+ (parseFloat(L.GeometryUtil.readableArea(area, true, 5).slice(0, -3))/100).toFixed(3) + " square kilometer";
        
                };
        
        // TODO : on mouseout finish the polygon
        
        // on draw
            map.on(L.Draw.Event.CREATED, function (e) {
                var type = e.layerType,
                        layer = e.layer;
						
            map.removeControl(drawControl);
			map.removeControl(layerControl);
            map.addControl(removeAllControl);
			layerControl.addTo(map);
            layer.on('mouseover', function (event) {
                layer.bindPopup(getPopupContent(layer)).openPopup();
            });
            layer.on('mouseout', function (event) {
                layer.bindPopup(getPopupContent(layer)).closePopup();
            });

			if (layer.getLatLngs()[0].length < 12) {
				layer.editing.enable()
			}
        
            drawnItems.addLayer(layer);
            
            drawnItems.setStyle({fillColor :'#33cc33',
                    fillOpacity:0.65,
                    color:"#248f24",
                    opacity: 1})

			

			var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs()

			change_lat_lngs(latlngs);
            
            });

			// on edit:
        
            map.on(L.Draw.Event.EDITVERTEX, function(e){

				drawnItems.eachLayer(function (layer) {

					lat_lngs = layer.getLatLngs()[0]

					// if (lat_lngs.length >= 12) {
					// 	layer.editing.disable()
					// }

					change_lat_lngs(lat_lngs)
				})

            })
        
         
           map.on(L.Draw.Event.DELETED, function (e) {
        
            if (Object.keys(e.layers._layers).length != 0) {
                map.removeControl(removeAllControl);
				map.removeControl(layerControl);
                map.addControl(drawControl);
				layerControl.addTo(map);
            }
        
            
        });
        
        </script>
	</body>
</html>