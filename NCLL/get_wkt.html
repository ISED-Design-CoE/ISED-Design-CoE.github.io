<!DOCTYPE html>
<!--[if lt IE 9]><html class="no-js lt-ie9" lang="en" dir="ltr"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en" dir="ltr"><!--<![endif]-->
	<head>
<!-- Based on CDTS 4.1.0 (https://cenw-wscoe.github.io/sgdc-cdts/docs/index-en.html) with DECoE customizations added (look for "DECoE customization" in comments) -->
	 <meta charset="utf-8">

<!-- Start DECoE customization -->
		<title>
			WKT tool - NCLL portal - Spectrum licensing services - Innovation, Science and Economic Development Canada
		</title>
<!-- End DECoE customization -->

		<meta content="width=device-width,initial-scale=1" name="viewport">
		<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/soyutils.js"></script>
		<script src="https://www.canada.ca/etc/designs/canada/cdts/gcweb/v4_1_0/cdts/compiled/wet-en.js"></script>
		<noscript>
			<!-- Write closure fall-back static file -->
			<!-- refTop.html -->
		</noscript>
		<!-- Write closure template -->
		<script>
			document.write(wet.builder.refTop({
				"cdnEnv": "esdcprod"
			}));
		</script>

<!-- Start DECoE customization -->

<link rel="stylesheet" href="libs/leaflet.css"/>
<link rel="stylesheet" href="src/leaflet.draw.css"/>

<script>
const baseQuery = window.location.search
var urlQueries = baseQuery
</script>

<!-- src does not work with folder, this is long but the best I can do because of 
	how leaflet draw is designed. -->
<script src="libs/leaflet-src.js"></script>
<script src="src/Leaflet.draw.js"></script>
<script src="src/Leaflet.Draw.Event.js"></script>
<script src="src/edit/handler/Edit.Poly.js"></script>
<script src="src/edit/handler/Edit.SimpleShape.js"></script>
<script src="src/edit/handler/Edit.Rectangle.js"></script>
<script src="src/draw/handler/Draw.Feature.js"></script>
<script src="src/draw/handler/Draw.Polyline.js"></script>
<script src="src/draw/handler/Draw.Polygon.js"></script>
<script src="src/draw/handler/Draw.SimpleShape.js"></script>
<script src="src/draw/handler/Draw.Rectangle.js"></script>
<script src="src/draw/handler/Draw.Circle.js"></script>
<script src="src/draw/handler/Draw.Marker.js"></script>
<script src="src/draw/handler/Draw.CircleMarker.js"></script>
<script src="src/ext/TouchEvents.js"></script>
<script src="src/ext/LatLngUtil.js"></script>
<script src="src/ext/GeometryUtil.js"></script>
<script src="src/ext/LineUtil.Intersect.js"></script>
<script src="src/ext/Polyline.Intersect.js"></script>
<script src="src/ext/Polygon.Intersect.js"></script>
<script src="src/Control.Draw.js"></script>
<script src="src/Tooltip.js"></script>
<script src="src/Toolbar.js"></script>
<script src="src/draw/DrawToolbar.js"></script>
<script src="src/edit/EditToolbar.js"></script>
<script src="src/edit/handler/EditToolbar.Edit.js"></script>
<script src="src/edit/handler/EditToolbar.Delete.js"></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

<script src="https://unpkg.com/esri-leaflet"></script>

<!-- Esri Leaflet Geocoder -->
<link
  rel="stylesheet"
  href="https://unpkg.com/esri-leaflet-geocoder/dist/esri-leaflet-geocoder.css"
/>
<script src="https://unpkg.com/esri-leaflet-geocoder"></script>


	<style>
		/* Styles for all mockups */
			.notesaboutmockup {
				color: #333;
				background: #FFD;
				padding: 0 1em;
				border-color: #FC6;
				border-width: 2px;
				border-style: solid;
				margin-top: 3em;
			}
			.notesaboutmockup h2 {
				font-size: inherit;
				margin-top: 1em;
			}
		/* Styles for this mockup */
			#map {
				border: 1px solid black;
				height: 65em;
				margin-bottom: 2em;
			}
			#WKT {
				width: 100%;
			}
			@media (min-width: 768px) {
				.dl-horizontal dt {
					width: 15em;
				}
			}
			.highlight {
				background-color: yellow;
			}
			.margin-top,
			#map-instructions {
				margin-top: 38px;	
			}
			.text-on-map{
				background:white;
				border-radius:4px;
				outline:2px solid rgba(0,0,0,0.2);
				padding:8px;
			}
			html {
				scroll-behavior: smooth;
			}
	</style>
	<link href="fix-wet-styles.css" rel="stylesheet" type="text/css">
	<link href="https://sms-sgs.ic.gc.ca/static/css/wizard.css" rel="stylesheet" type="text/css">
	<link href="ncll-portal.css" rel="stylesheet" type="text/css">
<!-- End DECoE customization -->

	</head>
	<body vocab="http://schema.org/" typeof="WebPage">
		<div id="def-top">
			<!-- Write closure fall-back static file -->
			<!-- transactTop-en.html -->
		</div>
		<!-- Write closure template -->
		<script>
			var defTop = document.getElementById("def-top");
			defTop.outerHTML = wet.builder.top({
				"cdnEnv": "esdcprod",
				"lngLinks": [{
					"lang": "fr",
					"href": "transactional-fr.shtml",
					"text": "Fran√ßais"
				}],
				"search": false,
				"siteMenu": false,

				"showPreContent": false
			});
		</script>

        <script>
            function copy() {
                console.log('test')
                let textarea = document.getElementById("WKT");
                textarea.select();
                console.log(textarea.value)
                navigator.clipboard.writeText(textarea.value);
                }
        </script>

		<main property="mainContentOfPage" typeof="WebPageElement" class="container">

<!-- Start page content -->

	<div id="superhead">
		<p>Non-competitive local (NCL) licence WKT tool</p>
	</div>

	<div class="wb-frmvld">

			<div class="wb-frm">
				<div class="container">


                    <div class="form-group margin-top">
						<label for="WKT">
							<span class="field-name" id="wkt-input">
								Licence area in WKT (Well Known Text) format
							</span>
						</label>
						<details>
							<summary>More information<span class="wb-inv"> about WKT</span></summary>
							<p>WKT is a compact format for describing mathematical shapes, including polygons. Each vertex is a longitude-latitude pair.</p>
							<p>e.g. POLYGON((<span class="highlight">-113.956370 50.880852</span>,<span class="highlight">-113.952550 50.880744</span>,<span class="highlight">-113.944869 50.882288</span>,<span class="highlight">-113.945942 50.884372</span>,<span class="highlight">-113.951950 50.883398</span>,<span class="highlight">-113.956885 50.882369</span>,<span class="highlight">-113.956370 50.880852</span>))</p>
							<p>The input field below accepts a polygon with up to 12 pairs.</p>
							<p>You can obtain a WKT description of your licence area using the <a href="SLAB-en-leaflet.html" target="_blank">NCLL spectrum licence browser</a>.</p>
						</details>

                        <div class="input-group">
                            <span class="input-group-btn">
                                <button style="width: 10em;" class="btn btn-primary" type="button" id="copy-button" onClick="copy()">Copy WKT</button>
                            </span>
                            <input type="text" id="WKT" name="WKT" disabled="true" class="form-control">
                        </div>

                    </div>


                        
					</div>
                    
					<div class="row">
							<details id="map-instructions">
								<summary>How to use the interactive map</summary>
								<p>To navigate the map:</p>

								<ul>
									<li>Search using the search bar at the top left of the map</li>
									<li>Click and drag to move the map</li>
									<li>Zoom in:</li>
									<ul>
										<li>Double click</li>
										<li>Scroll</li>
										<li>Click the zoom icons on the bottom right</li>
									</ul>
								</ul>
								<p>To draw:</p>
									<ol>
										<li>Navigate to your location</li>
										<li>Click the draw tool
											<svg width="30" height="30">
												<path xmlns="http://www.w3.org/2000/svg" transform="translate(-73,-15)" id="polygon" d="M 100,24.565 97.904,39.395 83.07,42 76,28.773 86.463,18 Z" style="fill:#464646;fill-opacity:1"/>
											</svg>

										</li>
										<li>Click on the map to add points. These are connected by straight lines.</li>
										<li>Close your boundary:</li>
										<ul>
											<li>Click the first point</li>
											<li>Click the finish button next to the draw icon</li>
										</ul>
										<li>Edit your boundary:</li>
										<ul>
											<li>Drag the white points to move them</li>
											<li>Drag the translucent points to add new points</li>
										</ul>
									</ol>
							</details>
							<div id="map"></div>
					</div>
				</div>

				<div class="notesaboutmockup">
					<h2>Notes about this mockup:</h2>
					<ul>
						<li>The three modes of input are dependent on each other: when one updates, they all update.</li>
						<li>Note error messages if people enter invalid data.</li>
					</ul>
					<h2>Changes from phase 2A BRD:</h2>
					<ul>
						<li>Ref. 5.8.4 Licence area page</li>
						<li>Added ability to enter coordinates in WKT</li>
						<li>Always show input fields for all 12 coordinates ("boundary points")</li>
						<li>Update layers available on the map</li>
						<li>Show licence areas on the map:
							<ul>
								<li>All granted and requested-but-not-denied licence areas from this licensee</li>
								<li>All regions where no 10-MHz or 20-MHz frequency range is available (as appropriate)</li>
							</ul>
						</li>
						<li>Removed check for RA exclusion zones</li>
						<li>Modify the information provided after the user clicks "Validate licence area" (now "Calculate fee")</li>
					</ul>
				</div>
			</div>
		</div>

	<script src="catch-and-throw.js"></script>
	<script>
		// Set up needed fields for cost calculation
		const renewable_temporary = urlParams.get('renewable-temporary')
		const temporary_licence = ( renewable_temporary == 'Temporary' )
		document.getElementById ( "renew-cost" ).setAttribute("hidden","hidden")
		document.getElementById ( "renew-min-cost" ).setAttribute("hidden","hidden")
		document.getElementById ( "temp-cost" ).setAttribute("hidden","hidden")
		document.getElementById ( "temp-min-cost" ).setAttribute("hidden","hidden")


		let baseRate = urlParams.get ( "base-rate" ) 

		if (baseRate == null) {baseRate = 0.45} // this is the rural rate

		createHiddenField ( "base-rate", baseRate )

		if (temporary_licence && urlParams.get( "already-divided" ) == null) {
			baseRate = baseRate / 12
			createHiddenField ( "already-divided", true)
		}
		for ( let elem of document .getElementsByClassName ( "base-rate" ) ) {
			elem .innerText = baseRate
		}
		createHiddenField ( "base-rate", baseRate )

		let feeZone = urlParams.get ( "fee-zone" ) 
		if (feeZone == null) {feeZone = "Rural"} // matches the default baseRate
		for ( let elem of document .getElementsByClassName ( "fee-zone" ) ) {
			elem .innerText = feeZone
		}
		createHiddenField ( "fee-zone", feeZone )
		// Get bandwidth (from previous page)
		const bandwidth = urlParams.get ( "bandwidth" )
		for ( let elem of document .getElementsByClassName ( "bandwidth" ) ) {
			elem .innerText = bandwidth
		}		
		var area_field = createHiddenField ( "area-size", 0 )
		var cost_field = createHiddenField ( "total-cost", 0 )
		var temp_cost_field = createHiddenField ( "temp-cost", 0 )
		var less_than_min_field = createHiddenField ( "less-than-min", false )
		
		const expiry_date = urlParams.get( "expiry-date" )
		if ( expiry_date ) {
			const effective_date = urlParams.get( "effective-date" )
			var duration = ((expiry_date.split("-")[0] - effective_date.split("-")[0]) * 12) + (expiry_date.split("-")[1] - effective_date.split("-")[1] + 1)

			for ( let elem of document .getElementsByClassName ( "licence-duration" ) ) {
				elem .innerText = duration
			}	
			var duration_field = createHiddenField ( "licence-duration", duration )
		}

		var area_number = 0;
		var cost_number = 0;
		var temp_cost_number = 0;
		const calculateButton = document.getElementById ( "calculate-button" )
		const calcResultsBefore = document.getElementById ( "calc-results-before" )
		const calcResultsAfter = document.getElementById ( "calc-results-after" )
		const nextButton = document.getElementById ( "next-button" )
		

		const powerLevel = urlParams.get ( "power-level" )

		const errorMessages = {}
		errorMessages [ "Zero area" ] = document.getElementById ( "zero-area-message" )
		errorMessages [ "Out of Canada" ] = document.getElementById ( "Out-of-Canada-message" )
		errorMessages [ "MP in urban area" ] = document.getElementById ( "MP-in-urban-message" )
		errorMessages [ "Too large for LP" ] = document.getElementById ( "LP-too-large-message" )
		errorMessages [ "Too small for MP but LP is OK" ] = document.getElementById ( "MP-too-small-but-LP-OK-message" )
		errorMessages [ "Too small for MP" ] = document.getElementById ( "MP-too-small-message" )
		errorMessages [ "Too large for MP" ] = document.getElementById ( "MP-too-large-message" )
		errorMessages [ "No duration" ] = document.getElementById ( "No-duration-message" )
		errorMessages [ "No bandwidth" ] = document.getElementById ( "No-bandwidth-message" )
		const licenceFeeText = document.getElementById ( "licence-fee-text" )

		function calculate_area_info () {

			less_than_min_field.setAttribute("value", false)

			document.getElementById ( "renew-cost" ).setAttribute("hidden","hidden")
			document.getElementById ( "renew-min-cost" ).setAttribute("hidden","hidden")
			document.getElementById ( "temp-cost" ).setAttribute("hidden","hidden")
			document.getElementById ( "temp-min-cost" ).setAttribute("hidden","hidden")

			urlQueries = baseQuery 

			for (let i = 0; i < 12; i++) {
					lat_id = "lat" + (i+1)
					long_id = "long" + (i+1)
					if (document.getElementById(lat_id).value != "") {
						urlQueries += "&" + lat_id + "=" + document.getElementById(lat_id).value
						urlQueries += "&" + long_id + "=" + document.getElementById(long_id).value
					
					}
				}
			urlQueries += "&area-size=" + area_number
			if (!temporary_licence) {
				if (cost_number > 48) {
					urlQueries += "&total-cost=" + cost_number
					
				} else {
					console.log('costs 48')
					urlQueries += "&total-cost=" + 48
					cost_field.setAttribute( "value", 48)
				}
			} else {
				if (temp_cost_number > 4) {
					urlQueries += "&total-cost=" + cost_number
				} else {
					console.log('costs 4')
					urlQueries += "&total-cost=" + 4 * duration
					cost_field.setAttribute( "value", 4 * duration )

				}
			}
			

			calcResultsBefore .setAttribute ( "hidden", "hidden" )
			calcResultsAfter .removeAttribute ( "hidden" )

			for ( let errorMessage in errorMessages ) {
				errorMessages [ errorMessage ] .setAttribute ( "hidden" , "hidden" )
			}
			licenceFeeText .setAttribute ( "hidden" , "hidden" )
			nextButton .setAttribute ( "hidden" , "hidden" )

			let noErrors = true
			// As appropriate, show error message
			if ( area_field .value == 0 ) { // If no area drawn, there can be no other errors
				noErrors = false
				errorMessages [ "Zero area" ] .removeAttribute ( "hidden" )
			} else {

				if ( false ) { // This should check if any part of the drawn area is outside Canada
					noErrors = false
					errorMessages [ "Out of Canada" ] .removeAttribute ( "hidden" )
				}

				if ( powerLevel == "Low power" ) {
					if ( area_field .value > 15 ) {
						noErrors = false
						errorMessages [ "Too large for LP" ] .removeAttribute ( "hidden" )
					}

				} else { // powerLevel == "Medium power"

					if ( feeZone == "Urban" ) {
						noErrors = false
						errorMessages [ "MP in urban area" ] .removeAttribute ( "hidden" )
					}

					if ( area_field .value <= 15 ) {
						noErrors = false
						errorMessages [ "Too small for MP but LP is OK" ] .removeAttribute ( "hidden" )
					} else if ( area_field .value < 75 ) {
						noErrors = false
						errorMessages [ "Too small for MP" ] .removeAttribute ( "hidden" )
					} else if ( area_field .value > 165 ) {
						noErrors = false
						errorMessages [ "Too large for MP" ] .removeAttribute ( "hidden" )
					}
				}
				if ( renewable_temporary == null || ( temporary_licence && effective_date == null )) {
					noErrors = false
					errorMessages [ "No duration" ] .removeAttribute ( "hidden" )
				}
				if ( bandwidth == null ) {
					noErrors = false
					errorMessages [ "No bandwidth" ] .removeAttribute ( "hidden" )
				}
			}
			if ( noErrors ) { // everything's okay
				if (temporary_licence) {
					if (temp_cost_number > 4) {
						document.getElementById('temp-cost').removeAttribute('hidden');
					} else {
						cost_number = 4 * duration

						total_cost_spans = document.querySelectorAll(".total-cost");
						total_cost_spans.forEach(element => {
							element.innerText = element.textContent = cost_number
						});
						document.getElementById('temp-min-cost').removeAttribute('hidden');
						less_than_min_field.setAttribute( "value", true )
					}
				} else {
					if (cost_number > 48) {
						document.getElementById('renew-cost').removeAttribute('hidden');
					} else {

						document.getElementById('renew-min-cost').removeAttribute('hidden');
						less_than_min_field.setAttribute( "value", true )
					}
				}
				licenceFeeText .removeAttribute ( "hidden" )
				nextButton .removeAttribute ( "hidden" )
			}
		}

		calculateButton.addEventListener ( "click", (event) => {
			calculate_area_info()
		})
	</script>
	<script>
		const saveButton = document.getElementById ( "save-button" )
		const saveDiv = document.getElementById ( "save-div" )
		saveButton.addEventListener ( "click", (event) => {
			saveDiv .removeAttribute ( "hidden" )
		})
	</script>
	</div>

	<script>
		// Read application number from parameters if present
		if ( urlParams .has ( "app-number" ) ) {
			const appNumberText = urlParams .get ( "app-number" )
			for ( let elem of document .getElementsByClassName ( "app-number" ) ) {
				elem .innerText = appNumberText
			}
		}

		if ( urlParams .has ( "power-level" ) ) {
			const powerLevel = urlParams .get ( "power-level" )
			if ( powerLevel == "Low power" ) {
				for ( let elem of document .getElementsByClassName ( "lp" ) ) {
					elem .removeAttribute ( "hidden" )
				}
			} else if ( powerLevel == "Medium power" ) {
				for ( let elem of document .getElementsByClassName ( "mp" ) ) {
					elem .removeAttribute ( "hidden" )
				}
			}
		}
	</script>
<!-- End page content -->

			<div id="def-preFooter">
				<!-- Write closure fall-back static file -->
				<!-- preFooter-en.html -->
			</div>
			<!-- Write closure template -->
			<script>
				var defPreFooter = document.getElementById("def-preFooter");
				defPreFooter.outerHTML = wet.builder.preFooter({
					"cdnEnv": "esdcprod",
					"versionIdentifier": "CD56",
					"showPostContent": false,
					"showFeedback": false,
					"showShare": false
				});
			</script>
		</main>
		<div id="def-footer">
			<!-- Write closure fall-back static file -->
			<!-- transactFooter-en.html -->
		</div>
		<!-- Write closure template -->
		<script>
			var defFooter = document.getElementById("def-footer");
			defFooter.outerHTML = wet.builder.footer({
				"cdnEnv": "esdcprod",
				"showFooter": false,
				"showFeatures": false,
				"termsLink": [{
        			"newWindow": true
				}],
				"privacyLink": [{
					"newWindow": true
				}],
				"contextualFooter":{
					"title": "Spectrum and Telecommunications Sector",
					"links": [{
						"text": "Contact us",
						"href":"https://ised-isde.canada.ca/site/spectrum-management-telecommunications/en/licences-and-certificates/radiocom-information-circulars-ric/ric-66-addresses-and-telephone-numbers-district-offices",
						"newWindow": true
					}]
				}
			});
		</script>
		<!-- Write closure template -->
		<script>
			document.write(wet.builder.refFooter({
				"cdnEnv": "esdcprod"
			}));
		</script>
		<script>


		// Leaflet code

			function reset_lat_lngs() {

				document.getElementById("WKT").value = "";
				
					
			}

	

			function change_lat_lngs(latlngs) {
				area = L.GeometryUtil.geodesicArea(latlngs);
				lat_long_sliced = latlngs.slice(0,12)
				let wkt = "POLYGON(("
				for (let i = 0; i < 12; i++) {
					if (i < lat_long_sliced.length) {
						wkt += latlngs[i].lng.toFixed(6) + " " + latlngs[i].lat.toFixed(6) + ","
					}
					
				}
			
				wkt = wkt.substring(0,wkt.length-1)
				wkt += "))"

				document.getElementById("WKT").value = wkt;

			}

			// create map and center to Muskeg
            var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                    osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    osm = L.tileLayer(osmUrl, {maxZoom: 18, attribution: osmAttrib}),
                    map = new L.Map('map', {zoomControl:false, layers: [osm], center: new L.LatLng(63.27268094792591, -100.5815661012755), zoom: 3.3,selectedPathOptions: {
                color:'#ff9900'
                }});
        
			// add the polygon that will be drawn to the map
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
        
			// add zoom to the bottom right
            new L.Control.Zoom({ position: 'bottomright' }).addTo(map);

			// add Fullscreen to the top right. Currently broken
            new L.Control.Fullscreen({pseudoFullscreen: true, position: 'topright'}).addTo(map);



			// Layers.

			// Draw control, removes everything but polygon,
			// and removes intersection from polygon.
			// Add area and restrict to 12 points.
        
            var drawControl = new L.Control.Draw({
                position: 'topleft',
                draw: {
                    polyline: false,
                    polygon: true,
                    circle: false,
                    rectangle: false,
                    marker: false,
                    circlemarker: false,
                polygon: {
                        allowIntersection: false,
                        showArea: true,
                        maxPoints:12,
                metric: "km",
                precision: {km:5},
                shapeOptions: {
                        fillColor :'#bf00ff',
                    fillOpacity:0.65,
                    color:"#8600b3",
                    opacity: 1
                          }
                }
        
                },
            });

			// Add search, currently does not work well, as I have not added an API key.
			var searchControl = L.esri.Geocoding.geosearch({
				expanded: true,
        	})

			map.addControl(searchControl)
            map.addControl(drawControl);

			// add scale to the bottom left.
            var scale = L.control.scale(); 
        	scale.addTo(map); 
		
        
			// When the user clicks the trashcan, remove everything and change the icon back to the polygon.
            L.Control.RemoveAll = L.Control.extend({
                options: {
                    position: 'topleft',
                },
        
                onAdd: function (map) {
                    var controlDiv = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
                    var controlUI = L.DomUtil.create('a', 'leaflet-draw-edit-remove', controlDiv);
                    controlUI.title = 'Remove all drawn items';
                    controlUI.setAttribute('href', '#');

                    controlUI.style.backgroundImage = 'url(src/images/trash.svg)'
        
                    L.DomEvent
                        .addListener(controlUI, 'click', L.DomEvent.stopPropagation)
                        .addListener(controlUI, 'click', L.DomEvent.preventDefault)
                        .addListener(controlUI, 'click', function () {
							reset_lat_lngs();
                            drawnItems.clearLayers();
                            map.removeControl(removeAllControl);
            				map.addControl(drawControl);
                        });
                    return controlDiv;
                }
            });
        
        removeAllControl = new L.Control.RemoveAll();
        
        
        // Add area on hover
        
        var getPopupContent = function(layer) {
        
                  var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs(),
                  area = L.GeometryUtil.geodesicArea(latlngs);
                  return "Area: "+ (parseFloat(L.GeometryUtil.readableArea(area, true, 5).slice(0, -3))/100).toFixed(3) + " square kilometer";
        
                };
        
        // TODO : on mouseout finish the polygon
        
        // on draw

			map.on( L.Draw.Event.DRAWVERTEX, function(e) {

				let temp_lats=[]
				let temp_longs=[]
				let temp_latlongs=[]

				layers = e.layers._layers
				if (Object.keys(layers).length >=3 ) {
					for (var vertex_id in layers) {
					temp_lats.push(layers[vertex_id]._latlng.lat)
					temp_longs.push(layers[vertex_id]._latlng.lng)
					}
					console.log(temp_latlongs)
					for (let i = 0; i < temp_lats.length; i++) {
						temp_latlongs.push({lat:temp_lats[i],lng:temp_longs[i]})
					}
					console.log(L.GeometryUtil.geodesicArea(temp_latlongs))
					temp_areas = document.querySelectorAll(".area-size-drawing");
					temp_areas.forEach(element => {
						element.innerText = element.textContent = (L.GeometryUtil.geodesicArea(temp_latlongs)/1000000).toFixed(3)
					});
				}

			}) 

            map.on(L.Draw.Event.CREATED, function (e) {
                var type = e.layerType,
                layer = e.layer;
						
            map.removeControl(drawControl);
            map.addControl(removeAllControl);
			layerControl.addTo(map);
            layer.on('mouseover', function (event) {
                layer.bindPopup(getPopupContent(layer)).openPopup();
            });
            layer.on('mouseout', function (event) {
                layer.bindPopup(getPopupContent(layer)).closePopup();
            });

			if (layer.getLatLngs()[0].length < 12) {
				layer.editing.enable()
			}
        
            drawnItems.addLayer(layer);
            
            drawnItems.setStyle({fillColor :'#33cc33',
                    fillOpacity:0.65,
                    color:"#248f24",
                    opacity: 1})

			

			var latlngs = layer._defaultShape ? layer._defaultShape() : layer.getLatLngs()


			console.log(latlngs)
			change_lat_lngs(latlngs);
            
            });

			// on edit:
        
            map.on(L.Draw.Event.EDITVERTEX, function(e){

				drawnItems.eachLayer(function (layer) {

					lat_lngs = layer.getLatLngs()[0]

					// if (lat_lngs.length >= 12) {
					// 	layer.editing.disable()
					// }

					change_lat_lngs(lat_lngs)

				})

            })
        
         
           map.on(L.Draw.Event.DELETED, function (e) {
        
            if (Object.keys(e.layers._layers).length != 0) {
                map.removeControl(removeAllControl);
                map.addControl(drawControl);
            }
        
            
        });
        
        </script>

<script>

if (document.getElementById("lat1").value != "") {

	lats = []
	longs = []
	lat_longs = [];

	wkt = "POLYGON(("
	
	for ( let i = 1; i < 13; i++ ) {
			if (document.getElementById("lat"+i).value != "") {
				temp_lat = document.getElementById("lat"+i).value
				temp_long = document.getElementById("long"+i).value

				lats.push(temp_lat);
				longs.push(temp_long);
				wkt += temp_long + " " + temp_lat + ","
				
				}
	}

		for (let i = 0; i < lats.length; i++) {
			lat_longs.push([lats[i],longs[i]])
		}

	wkt = wkt.substring(0,wkt.length-1) + "))"
	document.getElementById("WKT").value = wkt;

	map.removeControl(drawControl);
	map.addControl(removeAllControl);		
	area_size_spans = document.querySelectorAll(".area-size");
	area_size_spans.forEach(element => {
		console.log(document.getElementById("area-size").value)
		element.innerText = element.textContent = document.getElementById("area-size").value;
	});

	total_cost_spans = document.querySelectorAll(".total-cost");
	total_cost_spans.forEach(element => {
		element.innerText = element.textContent = document.getElementById("total-cost").value;
	});

	temp_cost_spans = document.querySelectorAll(".temp-cost");
	temp_cost_spans.forEach(element => {
		element.innerText = element.textContent = document.getElementById("temp-cost").value;
	});

	area_field.setAttribute( "value", document.getElementById("area-size").value );
	cost_field.setAttribute( "value", document.getElementById("total-cost").value );
	temp_cost_field.setAttribute( "value", document.getElementById("temp-cost").value );
	area_number=document.getElementById("area-size").value
	cost_number=document.getElementById("total-cost").value

	const polygon = L.polygon(lat_longs).addTo(map);

	polygon.on('mouseover', function (event) {
		polygon.bindPopup(getPopupContent(polygon)).openPopup();
	});
	polygon.on('mouseout', function (event) {
		polygon.bindPopup(getPopupContent(polygon)).closePopup();
	});

	if (polygon.getLatLngs()[0].length < 12) {
		polygon.editing.enable()
	}

	drawnItems.addLayer(polygon);
	
	drawnItems.setStyle({fillColor :'#33cc33',
			fillOpacity:0.65,
			color:"#248f24",
			opacity: 1})

	map.fitBounds(polygon.getBounds());
	calculate_area_info()


}




</script>
</html>
