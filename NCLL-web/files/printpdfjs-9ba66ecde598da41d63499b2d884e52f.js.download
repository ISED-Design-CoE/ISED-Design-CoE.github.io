/**
 * Print to PDF functionality
 * 
 * This script handles PDF printing preparation and formatting
 */

// Wait for DOM to be fully loaded before executing
document.addEventListener('DOMContentLoaded', function() {
  // Only initialize print button functionality if it exists
  initPrintButton();
  
  // Ensure any leftover print elements are removed (in case of page refresh during print)
  cleanupAllPrintElements();
});

/**
 * Clean up any print elements that might exist from previous attempts
 */
function cleanupAllPrintElements() {
  // Remove any print-specific elements that might exist
  const printElements = document.querySelectorAll('.print-only, #print-toc, #print-first-page-header, #print-banner-container, #toc-header-image, #first-page-header-image');
  printElements.forEach(element => {
    if (element && element.parentNode) {
      element.parentNode.removeChild(element);
    }
  });
  
  // Remove print-specific styles
  const printStyles = document.getElementById('print-specific-styles');
  if (printStyles && printStyles.parentNode) {
    printStyles.parentNode.removeChild(printStyles);
  }
}

/**
 * Initialize the print button functionality
 */
function initPrintButton() {
  var printButton = document.getElementById("printToPDF-button");
  if (printButton) {
    printButton.addEventListener("click", preparePrint);
  }
}

// ===================================================
// PRINT FUNCTIONALITY
// ===================================================

/**
 * Prepare the document for printing
 */
function preparePrint() {
  // First, clean up any existing print elements
  cleanupAllPrintElements();
  
  // Add print-specific styles
  prepareCSS();
  
  // Create a list to track elements added for printing (for cleanup)
  window.printElementsAdded = true;
  
  // Check if contents menu exists before creating table of contents
  const contentsMenuExists = document.getElementById('contents-menu');
  
  // Handle TOC or create first page header as needed
  if (contentsMenuExists) {
    // Create and position the table of contents with banner
    createTableOfContents();
  } else {
    // If no TOC, add banner to first page
    prepareFirstPageHeader();
  }
  
  // Store the original state of each details element
  const allDetails = document.querySelectorAll('details');
  const detailsStates = [];
  
  // Open all details elements and save their original state
  allDetails.forEach(detail => {
    // Save whether the details element was originally open
    detailsStates.push(detail.hasAttribute('open'));
    // Open all details for printing
    detail.setAttribute('open', '');
  });
  
  // Add section headers for printing
  addSectionHeaders();
  
  // Set up afterprint event handler for cleanup
  window.addEventListener('afterprint', function onAfterPrint() {
    // Clean up after printing
    cleanupAfterPrint(allDetails, detailsStates);
    
    // Remove this event listener to prevent multiple registrations
    window.removeEventListener('afterprint', onAfterPrint);
  }, {once: true});
  
  // Wait a moment for changes to apply
  setTimeout(function() {
    window.print();
    
    // Fallback cleanup in case afterprint event doesn't fire
    setTimeout(function() {
      if (window.printElementsAdded) {
        cleanupAfterPrint(allDetails, detailsStates);
      }
    }, 2000);
  }, 500);
}

/**
 * Clean up after printing is complete
 */
function cleanupAfterPrint(allDetails, detailsStates) {
  // Only run cleanup once
  if (!window.printElementsAdded) return;
  window.printElementsAdded = false;
  
  // Clean up all print-specific elements
  cleanupAllPrintElements();
  
  // Remove all section headers
  const sectionHeaders = document.querySelectorAll('.print-section-header');
  sectionHeaders.forEach(header => {
    if (header && header.parentNode) {
      header.parentNode.removeChild(header);
    }
  });
  
  // Restore details elements to their original state
  if (allDetails && detailsStates) {
    allDetails.forEach((detail, index) => {
      if (!detailsStates[index]) {
        // If it was originally closed, close it again
        detail.removeAttribute('open');
      }
    });
  }
  
  console.log('Print cleanup completed');
}

/**
 * Prepare a first page header with image when no TOC is present
 */
function prepareFirstPageHeader() {
  // Create container for the first page header
  const firstPageHeader = document.createElement('div');
  firstPageHeader.id = 'print-first-page-header';
  firstPageHeader.className = 'print-only';
  
  // Create banner image container with proper sizing
  const bannerContainer = document.createElement('div');
  bannerContainer.id = 'first-page-header-image';
  bannerContainer.className = 'print-only banner-container';
  
  // Create the image element
  const img = document.createElement('img');
  img.src = "https://ised-isde.canada.ca/site/spectrum-management-telecommunications/sites/default/files/image/ISED-ISDE-45e.png";
  img.alt = "ISED Logo";
  img.className = 'banner-image';
  
  // Add the image to the container
  bannerContainer.appendChild(img);
  firstPageHeader.appendChild(bannerContainer);
  
  // Add the page title
  const pageTitle = document.createElement('h1');
  pageTitle.id = 'print-page-title';
  pageTitle.className = 'print-only';
  pageTitle.textContent = document.title || 'Document';
  
  firstPageHeader.appendChild(pageTitle);
  
  // Insert at the beginning of the document body
  document.body.insertBefore(firstPageHeader, document.body.firstChild);
}

/**
 * Create a table of contents for printing
 */
function createTableOfContents() {
  // Check if contents-menu exists
  const contentsMenu = document.getElementById('contents-menu');
  if (!contentsMenu) {
    console.log('No contents-menu found, skipping table of contents creation');
    return;
  }
  
  // Create the TOC container
  const tocElement = document.createElement('div');
  tocElement.id = 'print-toc';
  tocElement.className = 'print-only';
  
  // Create banner image container with proper sizing
  const bannerContainer = document.createElement('div');
  bannerContainer.id = 'toc-header-image';
  bannerContainer.className = 'print-only banner-container';
  
  // Create the image element
  const img = document.createElement('img');
  img.src = "https://ised-isde.canada.ca/site/spectrum-management-telecommunications/sites/default/files/image/ISED-ISDE-45e.png";
  img.alt = "ISED Logo";
  img.className = 'banner-image';
  
  // Add the image to the container
  bannerContainer.appendChild(img);
  tocElement.appendChild(bannerContainer);
  
  // Add the page title
  const pageTitle = document.createElement('h1');
  pageTitle.id = 'print-page-title';
  pageTitle.className = 'print-only';
  pageTitle.textContent = document.title || 'Document';
  
  tocElement.appendChild(pageTitle);
  

  // Get the table of contents title from the #btn-contents element's text content
  const btnContents = document.getElementById('btn-contents');
  let tocTitleText = 'Table of Contents'; // Default fallback
  
  if (btnContents) {
      // Create a temporary clone of the button
      const tempElement = btnContents.cloneNode(true);
      
      // Remove all child elements (like the span) from the clone
      Array.from(tempElement.children).forEach(child => {
          tempElement.removeChild(child);
      });
      
      // Get the remaining text content and trim whitespace
      const btnText = tempElement.textContent.trim();
      
      if (btnText) {
          // If the text is 'Contents', use 'Table of Contents'
          if (btnText === 'Contents') {
              tocTitleText = 'Table of Contents';
          } else {
              tocTitleText = btnText; // Otherwise use exactly what's in the button
          }
      }
  }
  
  const tocTitle = document.createElement('h2');
  tocTitle.className = 'print-only';
  tocTitle.textContent = tocTitleText;
  tocElement.appendChild(tocTitle);
  
  // Create the TOC list
  const tocList = document.createElement('ul');
  tocList.className = 'print-only';
  tocList.style.paddingLeft = '0';
  tocList.style.listStyle = 'none';
  
  // Get the menu items directly from the contents-menu
  const menuItems = document.querySelectorAll('#contents-menu li a');
  
  if (menuItems && menuItems.length > 0) {
    menuItems.forEach(item => {
      const listItem = document.createElement('li');
      listItem.className = 'print-only';
      listItem.style.marginBottom = '0.5cm';
      listItem.style.display = 'flex';
      listItem.style.alignItems = 'baseline';
      
      const link = document.createElement('a');
      link.className = 'print-only';
      link.href = item.getAttribute('href');
      link.textContent = item.textContent;
      link.style.textDecoration = 'none';
      link.style.color = 'black';
      link.style.flexGrow = '1';
      
      // Add page number placeholder
      const pageRef = document.createElement('span');
      pageRef.className = 'page-ref print-only';
      pageRef.textContent = '';
      
      listItem.appendChild(link);
      listItem.appendChild(pageRef);
      tocList.appendChild(listItem);
    });
    
    tocElement.appendChild(tocList);
    
    // Insert at the beginning of the document body for maximum visibility
    document.body.insertBefore(tocElement, document.body.firstChild);
    
    console.log('Table of Contents created with items:', tocList.children.length);
  } else {
    console.log('No menu items found in #contents-menu, skipping table of contents creation');
  }
}

/**
 * Add section headers for printing
 */
function addSectionHeaders() {
  // Get all details elements
  const allDetails = document.querySelectorAll('details');
  
  allDetails.forEach((detail, index) => {
    // Find the summary and its heading
    const summary = detail.querySelector('summary');
    const heading = summary ? summary.querySelector('h2, h3, h4, .h2, .h3, .h4') : null;
    
    if (heading) {
      // Create a header element for printing
      const sectionHeader = document.createElement('div');
      sectionHeader.className = 'print-section-header print-only';
      sectionHeader.textContent = heading.textContent;
      
      // Insert the header at the beginning of the details content
      detail.insertBefore(sectionHeader, detail.firstChild.nextSibling);
    }
  });
}

/**
 * Prepare CSS styles for printing
 */
function prepareCSS() {
  // Add print-specific styles
  const printStyles = document.createElement('style');
  printStyles.id = 'print-specific-styles';
  
  // CSS content moved to a separate variable for better readability
  const cssContent = `
    /* Non-print styles */
    .print-only {
        display: none !important; /* Hide print-specific elements by default in normal view */
    }
    
    /* Print styles */
    @media print {
      /* Hide elements not needed in print */
      .sticky-nav, header, footer, aside, nav, form, iframe, .menu, .hero, .adslot {
        display: none !important;
      }
      
      /* Show print-only elements */
      .print-only {
        display: block !important;
      }
      
      /* Banner image container styling */
      .banner-container {
        display: block !important;
        width: 80% !important; /* Reduce width to prevent overflow */
        max-width: 800px !important;
        margin: 0 auto 20px auto !important;
        text-align: center !important;
        page-break-inside: avoid !important;
      }
      
      /* Banner image styling */
      .banner-image {
        width: 100% !important;
        height: auto !important;
        max-width: 100% !important;
        object-fit: contain !important;
      }
      
      /* Ensure TOC and its header image is visible */
      #print-toc, #toc-header-image, #print-first-page-header, #first-page-header-image {
        display: block !important;
        visibility: visible !important;
      }
      
      #print-toc, #print-first-page-header {
        margin: 0 auto 2cm auto !important;
        width: 90% !important;
        max-width: 90% !important;
        page-break-after: always !important;
      }
      
      /* Page title styling */
      #print-page-title {
        text-align: center !important;
        font-size: 24pt !important;
        margin-bottom: 1cm !important;
        margin-top: 1cm !important;
        page-break-after: avoid !important;
      }
      
      /* Show section headers in print */
      .print-section-header {
        display: block !important;
        font-size: 16pt !important;
        font-weight: bold !important;
        margin-top: 0.5cm !important;
        margin-bottom: 0.3cm !important;
        page-break-after: avoid !important;
        page-break-inside: avoid !important;
      }
  
      /* Table of Contents styling */
      #print-toc h2 {
        text-align: center !important;
        font-size: 18pt !important;
        margin-bottom: 1cm !important;
        margin-top: 1cm !important;
        page-break-after: avoid !important;
      }
      
      #print-toc ul {
        padding-left: 0 !important;
        list-style: none !important;
        width: 100% !important;
      }
      
      #print-toc li {
        margin-bottom: 0.5cm !important;
        display: flex !important;
        align-items: baseline !important;
      }
      
      #print-toc a {
        text-decoration: none !important;
        color: black !important;
        flex-grow: 1 !important;
        position: relative !important;
      }
      
      #print-toc a::after {
        content: " " !important;
        display: inline-block !important;
        border-bottom: 1px dotted #999 !important;
        position: absolute !important;
        width: 100% !important;
        left: 0 !important;
        bottom: 0.3em !important;
        z-index: -1 !important;
      }
      
      /* Adjust page layout */
      @page {
        size: letter; /* Use standard letter size */
        margin: 1in; /* 1 inch margins on all sides */
      }
      
      body {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* Fix for details elements */
      details {
        width: 100% !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
      }
      
      /* Prevent images from breaking across pages */
      img, drupal-media, figure, .panel-body, .panel, svg {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }
      
      /* Keep summary with at least some content */
      summary {
        break-after: avoid; /* Prevent summary from being separated from its content */
        list-style: none !important;
        padding-left: 0 !important;
      }
      
      /* Remove all possible markers and icons */
      summary::marker,
      summary::-webkit-details-marker,
      summary::before,
      summary::after {
        content: none !important;
        display: none !important;
      }
      
      /* Prevent headers from being orphaned at bottom of page */
      h3, h4, summary, .h3, .h4 {
        break-after: avoid !important;
        break-inside: avoid !important;
        page-break-after: avoid !important;
        orphans: 4;
        widows: 4;
      }
      
      /* Hide all closed details elements and their children */
      details:not([open]) {
        display: none !important;
      }
      
      /* Ensure the h2 within summary is visible when details is open */
      details[open] > summary,
      details[open] > summary h2 {
        display: block;
      }
      
      /* Hide the expand/collapse button */
      .wb-toggle {
        display: none;
      }
      
      a.btn.bg-info, #printToPDF-button, #print_note {
        display: none;
      }
      
      main {
        font-size: 16px;
        width: 100% !important;
      }
      
      /* Additional print-specific styles */
      details { display: block !important; }
      summary { display: none !important; }
      .no-print { display: none !important; }
      body { font-size: 12pt; }
    }
  `;
  
  printStyles.innerHTML = cssContent;
  document.head.appendChild(printStyles);
}